{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="fas fa-split"></i> Split Data GLCM
    </h2>
    <a href="{{ url_for('split.index') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Kembali
    </a>
  </div>

  {% if available_data %}
  <!-- Statistik Data Tersedia -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card bg-info text-white">
        <div class="card-body text-center">
          <h3>{{ available_data|length }}</h3>
          <p class="mb-0">Total Data Tersedia</p>
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Distribusi per Kategori</h6>
        </div>
        <div class="card-body">
          <div class="row">
            {% for stat in kategori_stats %}
            <div class="col-6 col-md-3 mb-2">
              <div class="text-center">
                <h5 class="text-primary">{{ stat.total }}</h5>
                <small class="text-muted">{{ stat.nama_kategori }}</small>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Split Method Selection -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-cogs"></i> Pilih Metode Split
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4 mb-3">
          <div class="card border-primary method-card" data-method="percentage">
            <div class="card-body text-center">
              <i class="fas fa-percentage fa-3x text-primary mb-3"></i>
              <h5>Percentage Split</h5>
              <p class="text-muted">Split berdasarkan persentase yang ditentukan</p>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="split_method" id="percentage" value="percentage" checked>
                <label class="form-check-label" for="percentage">Pilih Metode Ini</label>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card border-success method-card" data-method="stratified">
            <div class="card-body text-center">
              <i class="fas fa-layer-group fa-3x text-success mb-3"></i>
              <h5>Stratified Split</h5>
              <p class="text-muted">Mempertahankan proporsi setiap kategori</p>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="split_method" id="stratified" value="stratified">
                <label class="form-check-label" for="stratified">Pilih Metode Ini</label>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card border-warning method-card" data-method="manual">
            <div class="card-body text-center">
              <i class="fas fa-hand-pointer fa-3x text-warning mb-3"></i>
              <h5>Manual Split</h5>
              <p class="text-muted">Pilih manual data untuk train dan test</p>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="split_method" id="manual" value="manual">
                <label class="form-check-label" for="manual">Pilih Metode Ini</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Split Configuration -->
  <form method="POST" action="{{ url_for('split.process') }}" id="splitForm">
    <!-- Hidden input for split method -->
    <input type="hidden" name="split_method" value="percentage">
    
    <!-- Percentage & Stratified Options -->
    <div class="card mb-4" id="percentageOptions">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-sliders-h"></i> Konfigurasi Split
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Persentase Data Train (%)</label>
            <input type="range" class="form-range" id="trainPercentage" name="train_percentage" 
                   min="60" max="90" value="80" step="5">
            <div class="d-flex justify-content-between">
              <small class="text-muted">60%</small>
              <small class="text-muted">90%</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="row text-center">
              <div class="col-6">
                <div class="bg-success text-white p-3 rounded">
                  <h4 id="trainCount">0</h4>
                  <small>Data Train</small>
                  <div id="trainPercentageDisplay">80%</div>
                </div>
              </div>
              <div class="col-6">
                <div class="bg-warning text-dark p-3 rounded">
                  <h4 id="testCount">0</h4>
                  <small>Data Test</small>
                  <div id="testPercentageDisplay">20%</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Manual Selection Options -->
    <div class="card mb-4" id="manualOptions" style="display: none;">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-list-check"></i> Pilih Data Manual
        </h5>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <button type="button" class="btn btn-outline-success btn-sm" onclick="selectAllTrain()">
              <i class="fas fa-check-square"></i> Pilih Semua Train
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="clearAllTrain()">
              <i class="fas fa-square"></i> Clear Train
            </button>
          </div>
          <div class="col-md-6">
            <button type="button" class="btn btn-outline-warning btn-sm" onclick="selectAllTest()">
              <i class="fas fa-check-square"></i> Pilih Semua Test
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="clearAllTest()">
              <i class="fas fa-square"></i> Clear Test
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered table-sm">
            <thead class="table-dark">
              <tr>
                <th width="80">Gambar</th>
                <th>Nama File</th>
                <th>Kategori</th>
                <th>Fitur GLCM</th>
                <th width="80">Train</th>
                <th width="80">Test</th>
              </tr>
            </thead>
            <tbody>
              {% for data_citra, dataset, kategori in available_data %}
              <tr>
                <td>
                  <img src="{{ '/' ~ dataset.path_file }}" alt="{{ dataset.nama_file }}" 
                       width="50" height="50" class="img-thumbnail">
                </td>
                <td>
                  <strong>{{ dataset.nama_file }}</strong>
                  <br>
                  <small class="text-muted">ID: {{ data_citra.id_data_citra }}</small>
                </td>
                <td>
                  <span class="badge bg-secondary">{{ kategori.nama_kategori }}</span>
                </td>
                <td>
                  <small class="text-monospace">
                    C: {{ "%.3f"|format(data_citra.contrast) }}<br>
                    E: {{ "%.3f"|format(data_citra.energy) }}
                  </small>
                </td>
                <td>
                  <div class="form-check">
                    <input class="form-check-input train-checkbox" type="checkbox" 
                           name="train_data" value="{{ data_citra.id_data_citra }}"
                           onchange="handleManualSelection(this, 'train')">
                  </div>
                </td>
                <td>
                  <div class="form-check">
                    <input class="form-check-input test-checkbox" type="checkbox" 
                           name="test_data" value="{{ data_citra.id_data_citra }}"
                           onchange="handleManualSelection(this, 'test')">
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="row mt-3">
          <div class="col-md-6">
            <div class="alert alert-success">
              <strong>Data Train: <span id="manualTrainCount">0</span></strong>
            </div>
          </div>
          <div class="col-md-6">
            <div class="alert alert-warning">
              <strong>Data Test: <span id="manualTestCount">0</span></strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="card">
      <div class="card-body text-center">
        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
          <i class="fas fa-play"></i> Mulai Split Data
        </button>
        <div class="mt-3">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Informasi:</strong> Proses split akan membagi data GLCM untuk keperluan training dan testing model machine learning.
          </div>
        </div>
      </div>
    </div>
  </form>
  {% else %}
  <div class="card">
    <div class="card-body text-center py-5">
      <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
      <h4 class="text-warning">Tidak Ada Data Tersedia</h4>
      <p class="text-muted">Semua data GLCM sudah di-split atau belum ada data GLCM yang dapat di-split.</p>
      <div class="mt-4">
        <a href="{{ url_for('glcm.index') }}" class="btn btn-primary">
          <i class="fas fa-chart-line"></i> Kelola Data GLCM
        </a>
        <a href="{{ url_for('split.index') }}" class="btn btn-secondary">
          <i class="fas fa-list"></i> Lihat Data Split
        </a>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<style>
.method-card {
  cursor: pointer;
  transition: all 0.3s ease;
  height: 100%;
}

.method-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.method-card.selected {
  border-width: 2px;
  box-shadow: 0 0 15px rgba(0,123,255,0.3);
}

.card {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border: none;
}

.text-monospace {
  font-family: 'Courier New', monospace;
  font-size: 0.75rem;
}

.form-range {
  cursor: pointer;
}

.table td {
  vertical-align: middle;
}

@media (max-width: 768px) {
  .method-card {
    margin-bottom: 1rem;
  }
}
</style>

<script>
const totalData = {{ available_data|length }};

document.addEventListener('DOMContentLoaded', function() {
  // Initialize
  updatePercentageDisplay();
  updateMethodSelection();
  
  // Event listeners
  document.getElementById('trainPercentage').addEventListener('input', updatePercentageDisplay);
  
  document.querySelectorAll('input[name="split_method"]').forEach(radio => {
    radio.addEventListener('change', updateMethodSelection);
  });
  
  // Method card click handlers
  document.querySelectorAll('.method-card').forEach(card => {
    card.addEventListener('click', function() {
      const method = this.getAttribute('data-method');
      document.getElementById(method).checked = true;
      updateMethodSelection();
    });
  });
  
  // Form validation
  document.getElementById('splitForm').addEventListener('submit', function(e) {
    const method = document.querySelector('input[name="split_method"]:checked').value;
    
    if (method === 'manual') {
      const trainCount = document.querySelectorAll('.train-checkbox:checked').length;
      const testCount = document.querySelectorAll('.test-checkbox:checked').length;
      
      if (trainCount === 0 && testCount === 0) {
        e.preventDefault();
        alert('Pilih minimal satu data untuk train atau test!');
        return false;
      }
    }
    
    // Show loading
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
    
    return true;
  });
});

function updatePercentageDisplay() {
  const percentage = document.getElementById('trainPercentage').value;
  const trainCount = Math.floor(totalData * percentage / 100);
  const testCount = totalData - trainCount;
  const testPercentage = 100 - percentage;
  
  document.getElementById('trainCount').textContent = trainCount;
  document.getElementById('testCount').textContent = testCount;
  document.getElementById('trainPercentageDisplay').textContent = percentage + '%';
  document.getElementById('testPercentageDisplay').textContent = testPercentage + '%';
}

function updateMethodSelection() {
  const selectedMethod = document.querySelector('input[name="split_method"]:checked').value;
  
  // Update visual selection
  document.querySelectorAll('.method-card').forEach(card => {
    card.classList.remove('selected');
  });
  document.querySelector(`.method-card[data-method="${selectedMethod}"]`).classList.add('selected');
  
  // Show/hide options
  if (selectedMethod === 'manual') {
    document.getElementById('percentageOptions').style.display = 'none';
    document.getElementById('manualOptions').style.display = 'block';
    updateManualCounts();
  } else {
    document.getElementById('percentageOptions').style.display = 'block';
    document.getElementById('manualOptions').style.display = 'none';
  }
  
  // Update hidden form field
  document.querySelector('input[name="split_method"]').value = selectedMethod;
}

function handleManualSelection(checkbox, type) {
  const value = checkbox.value;
  const otherType = type === 'train' ? 'test' : 'train';
  const otherCheckbox = document.querySelector(`input[name="${otherType}_data"][value="${value}"]`);
  
  if (checkbox.checked && otherCheckbox.checked) {
    otherCheckbox.checked = false;
  }
  
  updateManualCounts();
}

function updateManualCounts() {
  const trainCount = document.querySelectorAll('.train-checkbox:checked').length;
  const testCount = document.querySelectorAll('.test-checkbox:checked').length;
  
  document.getElementById('manualTrainCount').textContent = trainCount;
  document.getElementById('manualTestCount').textContent = testCount;
}

function selectAllTrain() {
  document.querySelectorAll('.train-checkbox').forEach(checkbox => {
    checkbox.checked = true;
    // Uncheck corresponding test checkbox
    const testCheckbox = document.querySelector(`input[name="test_data"][value="${checkbox.value}"]`);
    if (testCheckbox) testCheckbox.checked = false;
  });
  updateManualCounts();
}

function clearAllTrain() {
  document.querySelectorAll('.train-checkbox').forEach(checkbox => {
    checkbox.checked = false;
  });
  updateManualCounts();
}

function selectAllTest() {
  document.querySelectorAll('.test-checkbox').forEach(checkbox => {
    checkbox.checked = true;
    // Uncheck corresponding train checkbox
    const trainCheckbox = document.querySelector(`input[name="train_data"][value="${checkbox.value}"]`);
    if (trainCheckbox) trainCheckbox.checked = false;
  });
  updateManualCounts();
}

function clearAllTest() {
  document.querySelectorAll('.test-checkbox').forEach(checkbox => {
    checkbox.checked = false;
  });
  updateManualCounts();
}
</script>
{% endblock %}